<#assign datagridid=tool.getuuid()>
<script type="text/javascript">
$('#company').datagrid({
		gridTitle 		: 	'客户信息管理' 	,//[可选] 标题。
		columns 		: 	[
									{
										name: 'id',
									    label: 'id',
									    align: 'center',
									    hide: true
									},
		        		  	 		{
			        		        	name: 'no',
			        		            label: '企业编号',
			        		            align: 'center',
			        		            width: 100,
			        		            edit:false,
			        		            add:true
			        		        },
		        		  	 		{
			        		        	name: 'name',
			        		            label: '企业名称',
			        		            align: 'center',
			        		            width: 70,
			        		            edit:false,
			        		            add:true
			        		        },{
			        		        	name: 'province',
			        		            label: '所在区域/省',
			        		            align: 'center',
			        		            render: function(value){
			        		            			var arr = '';
					        		            	$.ajax({
					        		                    url: "${rootpath}/Business/getByCode?code="+value,
					        		                    global: false,
					        		                    type: "GET",
					        		                    dataType: "json",
					        		                    async: false,
					        		                    success: function(msg) {
					        		                    	$.each(msg, function (n, value) {  
					        		                    		arr = msg[n].xzqh_name;
					        		                        });  
					        		                    }
					        		                });
					        		            	return arr;
			        		            		},
			        		            width: 70,
			        		            edit:true,
			        		            add:true
			        		        },{
			        		        	name: 'city',
			        		            label: '所在区域/市',
			        		            align: 'center',
			        		            render: function(value){
			        		            			var arr = '';
					        		            	$.ajax({
					        		                    url: "${rootpath}/Business/getByCode?code="+value,
					        		                    global: false,
					        		                    type: "GET",
					        		                    dataType: "json",
					        		                    async: false,
					        		                    success: function(msg) {
					        		                    	$.each(msg, function (n, value) {  
					        		                    		arr = msg[n].xzqh_name;
					        		                        });  
					        		                    }
					        		                });
					        		            	return arr;
			        		            		},
			        		            edit:true,
			        		            add:true
			        		        },{
			        		        	name: 'county',
			        		            label: '所在区域/县',
			        		            align: 'center',
			        		            render: function(value){
			        		            			var arr = '';
					        		            	$.ajax({
					        		                    url: "${rootpath}/Business/getByCode?code="+value,
					        		                    global: false,
					        		                    type: "GET",
					        		                    dataType: "json",
					        		                    async: false,
					        		                    success: function(msg) {
					        		                    	$.each(msg, function (n, value) {  
					        		                    		arr = msg[n].xzqh_name;
					        		                        });  
					        		                    }
					        		                });
					        		            	return arr;
			        		            		},
			        		            width: 80,
			        		            edit:true,
			        		            add:true
			        		        },{
			        		        	name: 'address',
			        		            label: '详细地址',
			        		            align: 'center',
			        		            width: 80,
			        		            edit:true,
			        		            add:true
			        		        },{
			        		        	name: 'type',
			        		            label: '企业类型',
			        		            align: 'center',
			        		            type: 'select',
			        		            items: [{'':'请选择'},{'产废单位':'产废单位'}, {'运输单位':'运输单位'}, {'接收单位':'接收单位'}],
			        		            rule: 'required',
			        		            width: 60,
			        		            edit:true,
			        		            add:true
			        		        },{
			        		        	name: 'postcode',
			        		            label: '邮编',
			        		            align: 'center',
			        		            width: 60,
			        		            rule: "postcode",
			        		            edit:true,
			        		            add:true
			        		        },{
			        		        	name: 'telephone',
			        		            label: '座机',
			        		            align: 'center',
			        		            width: 60,
			        		            rule: "tel",
			        		            edit:true,
			        		            add:true
			        		        },{
			        		        	name: 'mobile',
			        		            label: '电话',
			        		            align: 'center',
			        		            width: 120,
			        		            rule: "mobile",
			        		            edit:true,
			        		            add:true
			        		        },{
			        		        	name: 'email',
			        		            label: '邮箱',
			        		            align: 'center',
			        		            width: 120,
			        		            rule: "email",
			        		            edit:true,
			        		            add:true
			        		        },{
			        		        	name: 'legalperson',
			        		            label: '法人',
			        		            align: 'center',
			        		            width: 100,
			        		            edit:true,
			        		            add:true
			        		        },{
			        		        	name: 'ratepayerno',
			        		            label: '纳税人识别号',
			        		            align: 'center',
			        		            width: 100,
			        		            edit:true,
			        		            add:true
			        		        },{
			        		        	name: 'accountowner',
			        		            label: '开户人',
			        		            align: 'center',
			        		            width: 100,
			        		            edit:true,
			        		            add:true
			        		        },{
			        		        	name: 'account',
			        		            label: '账号',
			        		            align: 'center',
			        		            width: 100,
			        		            rule: "number",
			        		            edit:true,
			        		            add:true
			        		        },{
			        		        	name: 'principal',
			        		            label: '单位负责人',
			        		            align: 'center',
			        		            width: 100,
			        		            edit:true,
			        		            add:true
			        		        },{
			        		        	name: 'timecreated',
			        		            label: '创建时间',
			        		            align: 'center',
			        		            width: 100,
			        		            edit:false,
			        		            add:true,  
			        		            type: 'date',
			        		            pattern: 'yyyy-MM-dd HH:mm:ss'
			        		        },{
			        		        	name: 'receivecompany',
			        		            label: '接收单位',
			        		            align: 'center',
			        		            width: 100,
			        		            edit:false,
			        		            add:true,
			        		            render: function (value){
			        		            	var text = '';
			        		            	if(value == '' || value == null){
			        		            		return "";
			        		            	}
			        		            	$.ajax({
			        		        	        url: "${rootpath}/Business/listCompanyById?id=" + value,
			        		        	        global: false,
			        		        	        type: "GET",
			        		        	        dataType: "json",
			        		        	        async: false,
			        		        	        success: function(msg) {
			        		        	        	text = msg[0].name;
			        		        	        }
			        		        	    });
			        		            	return text;
			        		            }
			        		        },{
			        		        	name: 'id',
			        		            label: '操作',
			        		            align: 'center',
			        		            width: 50,
			        		            edit:false,
			        		            add:false,
			        		            render: function(value) {
			        		                return '<a href="${rootpath}/Business/company?id='+value+'" class="btn btn-green" data-toggle="dialog" data-id="processFormDetail" data-mask="true" data-width="800" data-height="600" data-type="POST" data-title="编辑" data-icon="edit"></a>'
			        		            },
			        		            edit:false,
		        		  	 			add:false
			        		        }
			        		       
		        		    ],//[可选] 表头模型，适用动态生成表头，如果未设置本参数，将自动转化静态表头为模型。
		//data 			: 	null 	,//[可选] 提供datagrid需要的数据，如果同时设置有dataUrl参数，本参数优先级高。
		dataUrl 		: 	'${rootpath}/Business/companyManager_get' 	,//[可选] Ajax请求数据的URL。
		loadType 		: 	'POST' 	,//[可选] Ajax请求方式。
		dataType 		: 	'json' 	,//[可选] 数据类型，可选参数['json' | 'array' | 'xml']。
		//hiddenFields 	: 	null 	,//[可选] 仅用于dataType='array'时隐藏字段，可以将不能加载到页面上的值设置到给定的字段，array数据除去表头的列后依次赋值。
		local 			: 	'local' ,//[可选] 处理数据方式，可选参数['local' | 'remote']，(影响（分页、排序、筛选）)。
		fieldSortable 	: 	true 	,//[可选] 点击页头字段快速排序。普通表格转为datagrid的，需设置dataUrl参数，local = 'remote'
		filterThead 	: 	false 	,//[可选] 允许表格头部快速筛选。普通表格转为datagrid的，需设置dataUrl参数，local = 'remote'
		sortAll 		: 	true 	,//[可选] 排序范围，true = 所有数据排序， false = 当前页数据排序。普通表格转为datagrid的，默认为true
		filterAll 		: 	true 	,//[可选] 筛选范围，true = 从所有数据中筛选，false = 从当前页数据中筛选。普通表格转为datagrid的，默认为true
		filterMult 		: 	true 	,//[可选] 支持多字段筛选。
		linenumberAll 	: 	true 	,//[可选] 行号范围，true = 为所有数据编号，false = 为当前页数据编号。
		showLinenumber 	: 	true 	,//[可选] 是否显示行号，参数[true | false | 'lock']，lock参数 = 锁定行号列（适用于多列字段，出现横向滚动条的情况）。
		showCheckboxcol : 	false 	,//[可选] 是否显示行复选框，参数同上。
		showEditbtnscol : 	false 	,//[可选] 是否显示编辑按钮列。
		showTfoot 		: 	false 	,//[可选] 是否显示页脚，适用于显示统计信息，需要字段相关参数支持。
		showToolbar 	: 	true 	,//[可选] 是否显示工具条，需要设置参数toolbarItem或toolbarCustom。
		toolbarItem 	: 	'refresh' 	,//[可选] 显示工具条按钮，可选参数['all, add, edit, cancel, save, del, import, export, |']，“all” = 显示所有按钮，“|” = 按钮组分隔符。
		toolbarCustom 	: 	'<a href="${rootpath}/Business/company" class="btn btn-blue" data-toggle="dialog" data-width="800" data-height="600" data-id="dialog-mask" data-mask="true"><i class="fa fa-plus"></i> 添加</a>&nbsp;&nbsp;' 	,//[可选] 自定义的html内容或jQuery DOM对象，支持带返回值函数。
		columnResize 	: 	true 	,//[可选] 允许调整列宽。
		columnMenu 		: 	true 	,//[可选] 表头字段列上显示菜单按钮。
		columnShowhide 	: 	true 	,//[可选] 表头字段列菜单上出现 “显示/隐藏 列” 选项。
		columnFilter 	: 	true 	,//[可选] 表头字段列菜单上出现 “过滤” 选项。
		columnLock 		: 	true 	,//[可选] 表头字段列菜单上出现 “锁定列、解除锁定” 选项。
		paging 			: 	{pageSize:15, selectPageSize:'15,30,60,100', pageCurrent:1, showPagenum:5, total:0} 	,//[可选] 是否显示分页组件，可设置分页参数。分页参数模板：{pageSize:30, selectPageSize:'30,60,90', pageCurrent:1, showPagenum:5}
		pagingAlign 	: 	'left',//[可选] 分页组件对齐方式，参数['left' | 'center' | 'right']
		editUrl 		: 	'${rootpath}/Business/companyManager_edit' 	,//[可选] 保存编辑、添加数据的url，Ajax请求方式为POST，服务器端接收的参数名称为"json"，数据类型是JSON Array。
		//editCallback 	: 	null 	,//[可选] 保存成功后的回调，返回的json内容可以是B-JUI默认的回调json或保存后的json数据，datagrid默认回调：如果返回保存后的json数据，将会更新对应的数据行。
		editMode 		: 	'dialog',//[可选] 编辑、添加数据的方式，参数[false | 'inline' | 'dialog']。false = 不能编辑，inline = 行内编辑，dialog = 弹窗编辑。
		editDialogOp 	: 	{width:500, height:700}	,//[可选] 弹窗编辑方式时，设置弹出窗口的参数，如{width:500, height:300, mask:false}
		inlineEditMult 	: 	true 	,//[可选] 允许行内编辑模式下同时添加/编辑多行。
		saveAll 		: 	true 	,//[可选] 适用于多行行内编辑时，一次性保存全部数据，发送到服务器端数据格式见参数editUrl。
		addLocation 	: 	'first'	,//[可选] 添加新行数据于当前页的位置，参数['first' | 'last' | 'prev' | 'next']，参数prev和next参考当前选中行位置。
		delUrl 			: 	'${rootpath}/Business/companyManager_delete' 	,//[可选] 删除数据的url，服务器端接收的数据见参数delPK
		delType 		: 	'POST' 	,//[可选] Ajax删除数据的请求方式。
		//delPK 			: 	null 	,//[可选] 设置删除主键名，如果设置了主键，则只发送该字段的值(删除多条则主键值以逗号分隔)到服务器端，否则发送JSON数据（参数名"json"，数据类型为JSON Array）。
		delConfirm 		: 	'删除操作无需保存，直接生效，是否继续删除？' 	,//[可选] 删除前的确认提示，参数[true | false | '自定义提示信息']，参数为false时不弹出提示信息。
		//delCallback 	: 	null 	,//[可选] 删除成功后的回调函数，返回的json内容为B-JUI默认的回调json。
		contextMenuH 	: 	true 	,//[可选] 在表头上右键点击时出现 ”显示/隐藏列“ 的快捷菜单。
		contextMenuB 	: 	true 	,//[可选] 在数据行右键点击时出现快捷菜单，菜单选项有(刷新、添加、编辑、取消、删除)。
		hScrollbar 		: 	true 	,//[可选] 允许出现横向滚动条。
		fullGrid 		: 	true 	,//[可选] 使表格铺满网格容器(如果值为true，则需要设置有列宽，并且总宽度小于datagrid容器宽度时有效)。
		width 			: 	'100%' 	,//[可选] datagrid容器宽度，默认为父容器的宽，相当于'100%'。
		height 			: 	'100%' 	//,//[可选] datagrid容器高度。
		//importOption 	: 	null 	,//[可选] 工具栏的导入按钮参数，dialog或navtab方式打开导入页面，参数模板{type:"dialog", options:{url:'', width:400, height:200}}
		//exportOption 	: 	null 	,//[可选] 工具栏的导出按钮参数，执行ajax url或以dialog or navtab方式打开导出页面，参数模板{type:"ajax", options:{url:""}}
		//beforeEdit 		: 	null 	,//[可选] 带返回值方法，编辑数据前调用，返回true继续编辑，返回false取消编辑。
		//beforeDelete 	: 	null 	,//[可选] 带返回值方法，删除数据前调用，返回true继续删除，返回false取消删除。
		//afterSave 		: 	null 	,//[可选] 保存成功后执行方法，参数$trs为保存行(jQuery 对象)，datas为保存行对应数据(JSON Array)。
		//afterDelete 	: 	null 	 //[可选] 删除成功后执行方法。
	});
	
	var flag = true;
	
	//上次选中的行号
	var initRowNo = null;
	
	function doEdit(){
		//初始化编辑按钮的href
		$("#doEdit").removeAttr('href');
		//选择的行号
		var rowNo = $(".datagrid-selected-tr td:eq(0)").text();
		//选择行的Id
		var chooseValue = $(".datagrid-selected-tr td:eq(1)").text();
		if(chooseValue == undefined || chooseValue == ''){
			$("#doEdit").attr('data-toggle','');
			$("#company").alertmsg('info', '未选中任何行', {displayMode:'slide', displayPosition:'topcenter', okName:'确定', title:'信息提示', autoClose:false, okCall:'function(){$("#doEdit").attr("data-toggle","dialog");}'});
		} else {
			debugger;
			if(initRowNo != null && rowNo != initRowNo){
				//刷新datagrid
				$("#company").datagrid("refresh");
				//选中要操作的行
				$("#company").datagrid("selectedRows", rowNo -1, true);
			}
			initRowNo = rowNo;
			$("#doEdit").attr('href','${rootpath}/Business/company?id=' + chooseValue);
		}
	}
</script>
<div class="bjui-pageContent">
	<div style="height:100%"><table id="company" class="table table-bordered"></table></div>
</div>